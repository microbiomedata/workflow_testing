# MetaT Testing 

Metatransciptomics (MetaT) testing was performed on a San Diego Super Computing (SDSC) server nmdc-edge.org, with global cromwell configuration to run 
Workflow Definition Language (WDL) scripts to accomodate each workflow step. The Metatransciptomics workflow requires [Docker](https://www.docker.com/) 
(Docker >= v2.1.0.3) and a running instance of [cromwell](https://github.com/broadinstitute/cromwell); all third party tools are pulled down from [Dockerhub]
(https://hub.docker.com/). The Server on nmdc-edge.org runs a global cromwell configuration that is needed to support the metatranscriptomics workflow, along 
with other workflows,devoloped for the NMDC. To successfully run MetaT on nmdc-edge.org, there are 3 requirements:


## Inputs

The ```inputs.json``` file requires the following:

- `proj`: A unique name for your project or sample.
- `input_file`: Full path to the fastq file. The file must be intereleaved paired end fastq.
- `git_url`: A link to this version. Update it based on which version you downloaded.
- `url_base`: A web location where all the data objects from this run will be stored.
- `url_root`: Same as url_base.
- `outdir`: Full path of the folder where all the important outputs will be saved.
- `resource`: A short description or name of where the data was processed.
- `database`: Full path to a folder where RQC (`RQCFilterData/`) and IMG (`img/`) annotation database are located. Within the `IMG` folder following folders are expected:

```
    Cath-FunFam  COG  IMG-NR  Pfam  Product_Name_Mappings  Rfam  SMART  SuperFamily  TIGRFAM
```

- `threads`: Number of threads.
- `activity_id`: A unique ID for the project.
- `metat_folder`: Full path to metaT folder.

Where the ```inputs.json``` file will look like so:

```json
{
    "nmdc_metat.proj": "gold:Ga0370541",
    "nmdc_metat.input_file": "$edge_home/test/test_metag/test_smaller_interleave.fastq.gz",
    "nmdc_metat.git_url": "https://github.com/microbiomedata/mg_annotation/releases/tag/0.1",
    "nmdc_metat.url_base": "https://data.microbiomedata.org/data/",
    "nmdc_metat.outdir": "$edge_home//test/metaT/small_test",
    "nmdc_metat.resource": "NERSC - Cori",
    "nmdc_metat.url_root": "https://data.microbiomedata.org/data/",
    "nmdc_metat.database": "$edge_home/nmdc/refdata/",
    "nmdc_metat.activity_id": "small_test",
    "nmdc_metat.threads": 32 ,
    "nmdc_metat.metat_folder": "$edge_home//test/metaT/"
}
```

## Requirements for running MetaT

- `workflowSource`: Full path to input.json file for MetaT
- `workflowInputs`: Full path to metaT.wdl. This is the main workflow contianing tasks to run MetaT.
- `worfkowDependencies`: Zip file containing all WDL dependencies. Needs to be provided to allow main workflow imports for metaT.wdl

The **imports.zip** file was created by running ``` zip -r imports.zip wdls/```, where all WDLS for MetaT can be found [here](https://github.com/microbiomedata/metaT/tree/main/wdls)

## Command to run MetaT

With data prepared, MetaT is run by calling ``` curl http://localhost:8000/api/workflows/v1 -F "workflowSource=@$edge_home/test/metaT/wdls/metaT.wdl" -F "workflowInputs=@$edge_home/test/metaT/52390_inputs.json" -F "workflowDependencies=@$edge_home/test/metaT/wdls/imports.zip" ```

The curl command sends a request to the Cromwell API workflow submission endpoint with the required files, workflowSource, workflowInputs and workflowDependencies included as ``` -F, --form options ```.

Once the command is submitted, the workflow can be followed by either query the contents of systemd:
``` sudo journalctl -f -n100 -u cromwell.service ```

Or by tracking the progress of the workflow in the logfile generated by cromwell which can be found by its unique ID:

``` $edge_home/cromwell/cromwell-workflow-logs/workflow.3a6d3d62-2801-4c4a-ba36-e89781d8ab36.log ```

The unique ID ``` 3a6d3d62-2801-4c4a-ba36-e89781d8ab36 ``` was generated as soon as the job is submitted and is viewable right away. 

## Outputs 

Once the output is generated, all outputs can be found in the ```output``` directory specified in the input file. 

Expected outputs are:

- `outdir/annotation`: contains gff files from annotation run.
- `outdir/assembly`: contains FASTA fils from assembly.
- `outdir/mapback`: BAM file where reads were mapped back to the contigs.
- `outdir/metat_output`: A JSON file that has records for feature, their annotations, read counts from featurecount, and FPKM values. 
- `outdir/qa`: contains cleaned reads and a file with associated statistics

## Testing files 

Initial tests were performed on [344 KB](https://github.com/microbiomedata/metaT/blob/main/test_data/small_test/test_smaller_interleave.fastq.gz), [603 KB]
(https://github.com/microbiomedata/metaT/blob/main/test_data/small_test/test_small_interleave.fastq.gz), [5.51 MB](https://github.com/microbiomedata/metaT/blob/
main/test_data/large_test/gold_Ga0370541_out.json.gz) Fastq files before moving on for larger data processing.


## Navigating Files for MetaT testing on nmdc-edge

- `Test Directory`: $edge_home/test/
- `MetaT Test Directory`: $edge_home/test/MetaT
- `MetaT Input File`: $edge_home/test/test_metag/small_test_input.json
- `MetaT Main WDL`: $edge_home/test/metaT/wdls/metaT.wdl
- `MetaT Imports File`: $edge_home/test/metaT/wdls/imports.zip
- `MetaT WDL's`: $edge_home/test/metaT/wdls/

For the job to run successfully, all data mounts must be located within ```$edge_home/ ``` for the cromwell configuration see the inputs 
and allow permissions.